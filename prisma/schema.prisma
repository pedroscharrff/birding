// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ENUMS
// ============================================

enum Moeda {
  BRL
  USD
  EUR
}

enum StatusOS {
  planejamento
  cotacoes
  reservas_pendentes
  reservas_confirmadas
  documentacao
  pronto_para_viagem
  em_andamento
  concluida
  pos_viagem
  cancelada
}

enum TipoTransporte {
  van
  quatro_x_quatro @map("4x4")
  executivo_cidade
  executivo_fora_cidade
  aereo_cliente
  aereo_guia
}

enum TipoLancamento {
  entrada
  saida
  adiantamento
  ajuste
  receita_os      // Receita de venda de OS/Tour
  comissao        // Comissão de agente/guia
}

enum CategoriaLancamento {
  hospedagem
  guiamento
  transporte
  alimentacao
  atividade
  taxa
  passagem_aerea
  despesa_guia
  despesa_motorista
  receita_tour    // Receita de venda de tour
  comissao_agente // Comissão do agente
  comissao_guia   // Comissão do guia
  reembolso       // Reembolsos diversos
  cancelamento    // Taxas de cancelamento
  outros
}

enum StatusPagamento {
  pendente
  parcial
  pago
  atrasado
  cancelado
}

enum RoleGlobal {
  admin
  agente
  guia
  motorista
  fornecedor
  cliente
}

enum TipoFornecedor {
  hotelaria
  guiamento
  transporte
  alimentacao
  atividade
  outros
}

enum CategoriaOSFornecedor {
  hotelaria
  guiamento
  transporte
  alimentacao
  atividade
}

enum RegimeHospedagem {
  sem_cafe
  cafe
  meia_pensao
  pensao_completa
  all_inclusive
}

enum CategoriaPassagemAerea {
  cliente
  guia
}

enum TipoEventoCalendario {
  chegada
  saida
  atividade
  transporte
  checkpoint
}

enum RecursoCalendario {
  guia
  motorista
  veiculo
  fornecedor
  outros
}

enum AcaoAuditoria {
  criar
  atualizar
  excluir
  visualizar
  exportar
  status_alterado
}

enum EntidadeAuditoria {
  os
  participante
  fornecedor_os
  atividade
  hospedagem
  transporte
  passagem_aerea
  guia_designacao
  motorista_designacao
  scouting
  lancamento_financeiro
  pagamento_os
  anotacao
}

// ============================================
// TABELAS
// ============================================

model Organizacao {
  id        String   @id @default(uuid())
  nome      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  usuarios              Usuario[]
  fornecedores          Fornecedor[]
  os                    OS[]
  lancamentosFinanceiros LancamentoFinanceiro[]
  pagamentosOS          PagamentoOS[]
  eventosCalendario     EventoCalendario[]
  presetCategories      PresetCategory[]
  presetItems           PresetItem[]
  presetTemplates       PresetTemplate[]
  auditorias            AuditoriaOS[]
  policies              OrganizacaoPolicy[]
  cotacoes              Cotacao[]

  @@index([nome])
  @@map("organizacoes")
}

model Usuario {
  id          String      @id @default(uuid())
  orgId       String      @map("org_id")
  nome        String
  email       String      @unique
  telefone    String?
  roleGlobal  RoleGlobal  @map("role_global")
  hashSenha   String      @map("hash_senha")
  ativo       Boolean     @default(true)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Relations
  organizacao            Organizacao            @relation(fields: [orgId], references: [id], onDelete: Cascade)
  osResponsavel          OS[]                   @relation("OSResponsavel")
  guiaDesignacoes        GuiaDesignacao[]
  motoristaDesignacoes   MotoristaDesignacao[]
  scoutings              Scouting[]
  lancamentosReferencia  LancamentoFinanceiro[] @relation("LancamentoReferenciaUsuario")
  lancamentosCriados     LancamentoFinanceiro[] @relation("LancamentoCriadoPor")
  anotacoes              Anotacao[]
  historicoStatus        HistoricoStatus[]
  auditorias             AuditoriaOS[]
  cotacoes               Cotacao[]

  @@index([orgId])
  @@index([email])
  @@index([roleGlobal])
  @@map("usuarios")
}

model Fornecedor {
  id            String          @id @default(uuid())
  orgId         String          @map("org_id")
  nomeFantasia  String          @map("nome_fantasia")
  razaoSocial   String?         @map("razao_social")
  tipo          TipoFornecedor
  email         String?
  telefone      String?
  documento     String?
  endereco      Json?
  obs           String?
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  // Relations
  organizacao            Organizacao            @relation(fields: [orgId], references: [id], onDelete: Cascade)
  osFornecedores         OSFornecedor[]
  atividades             Atividade[]
  hospedagens            Hospedagem[]
  transportes            Transporte[]
  lancamentosFinanceiros LancamentoFinanceiro[]
  pagamentosOS           PagamentoOS[]
  tarifas                FornecedorTarifa[]
  cotacaoItens           CotacaoItem[]

  @@index([orgId])
  @@index([tipo])
  @@index([nomeFantasia])
  @@map("fornecedores")
}

model FornecedorTarifa {
  id            String    @id @default(uuid())
  fornecedorId  String    @map("fornecedor_id")
  descricao     String
  valor         Decimal   @db.Decimal(12, 2)
  moeda         Moeda     @default(BRL)
  unidade       String?   // Ex: "por pessoa", "por dia", "por grupo", "por km"
  vigenciaInicio DateTime? @map("vigencia_inicio") @db.Date
  vigenciaFim    DateTime? @map("vigencia_fim") @db.Date
  ativo         Boolean   @default(true)
  observacoes   String?
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  fornecedor  Fornecedor   @relation(fields: [fornecedorId], references: [id], onDelete: Cascade)
  hospedagens Hospedagem[]

  @@index([fornecedorId])
  @@index([ativo])
  @@index([vigenciaInicio])
  @@index([vigenciaFim])
  @@map("fornecedor_tarifas")
}

model OS {
  id                    String     @id @default(uuid())
  orgId                 String     @map("org_id")
  titulo                String
  destino               String
  dataInicio            DateTime   @map("data_inicio") @db.Date
  dataFim               DateTime   @map("data_fim") @db.Date
  status                StatusOS   @default(planejamento)
  agenteResponsavelId   String     @map("agente_responsavel_id")
  descricao             String?
  checklist             Json?

  // Campos Financeiros
  valorVenda            Decimal?   @map("valor_venda") @db.Decimal(12, 2)
  moedaVenda            Moeda      @default(BRL) @map("moeda_venda")
  valorRecebido         Decimal?   @map("valor_recebido") @db.Decimal(12, 2) @default(0)
  custoEstimado         Decimal?   @map("custo_estimado") @db.Decimal(12, 2)
  custoReal             Decimal?   @map("custo_real") @db.Decimal(12, 2)
  margemEstimada        Decimal?   @map("margem_estimada") @db.Decimal(5, 2) // Percentual
  obsFinanceiras        String?    @map("obs_financeiras") @db.Text

  createdAt             DateTime   @default(now()) @map("created_at")
  updatedAt             DateTime   @updatedAt @map("updated_at")

  // Relations
  organizacao            Organizacao            @relation(fields: [orgId], references: [id], onDelete: Cascade)
  agenteResponsavel      Usuario                @relation("OSResponsavel", fields: [agenteResponsavelId], references: [id])
  participantes          Participante[]
  fornecedores           OSFornecedor[]
  atividades             Atividade[]
  hospedagens            Hospedagem[]
  transportes            Transporte[]
  passagensAereas        PassagemAerea[]
  guiasDesignacao        GuiaDesignacao[]
  motoristasDesignacao   MotoristaDesignacao[]
  scoutings              Scouting[]
  lancamentosFinanceiros LancamentoFinanceiro[]
  pagamentos             PagamentoOS[]
  anotacoes              Anotacao[]
  historicoStatus        HistoricoStatus[]
  eventosCalendario      EventoCalendario[]
  auditorias             AuditoriaOS[]
  policySnapshots        OSPolicySnapshot[]

  @@index([orgId])
  @@index([status])
  @@index([dataInicio])
  @@index([dataFim])
  @@index([destino])
  @@index([agenteResponsavelId])
  @@map("os")
}

model Participante {
  id                  String    @id @default(uuid())
  osId                String    @map("os_id")
  nome                String
  email               String
  telefone            String?
  passaporteNumero    String?   @map("passaporte_numero")
  passaporteValidade  DateTime? @map("passaporte_validade") @db.Date
  alergias            String?
  restricoes          String?
  preferencias        String?
  idade               Int?
  observacoes         String?
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  os OS @relation(fields: [osId], references: [id], onDelete: Cascade)

  @@index([osId])
  @@index([email])
  @@index([passaporteNumero])
  @@map("os_participantes")
}

model OSFornecedor {
  id              String                 @id @default(uuid())
  osId            String                 @map("os_id")
  fornecedorId    String                 @map("fornecedor_id")
  categoria       CategoriaOSFornecedor
  contatoNome     String?                @map("contato_nome")
  contatoEmail    String?                @map("contato_email")
  contatoTelefone String?                @map("contato_telefone")
  contratoRef     String?                @map("contrato_ref")
  createdAt       DateTime               @default(now()) @map("created_at")
  updatedAt       DateTime               @updatedAt @map("updated_at")

  // Relations
  os         OS         @relation(fields: [osId], references: [id], onDelete: Cascade)
  fornecedor Fornecedor @relation(fields: [fornecedorId], references: [id])

  @@index([osId])
  @@index([fornecedorId])
  @@index([categoria])
  @@map("os_fornecedores")
}

model Atividade {
  id                String      @id @default(uuid())
  osId              String      @map("os_id")
  nome              String
  valor             Decimal?    @db.Decimal(12, 2)
  moeda             Moeda       @default(BRL)
  localizacao       String?
  quantidadeMaxima  Int?        @map("quantidade_maxima")
  data              DateTime?   @db.Date
  hora              DateTime?   @db.Time
  fornecedorId      String?     @map("fornecedor_id")
  notas             String?

  // Controle de Pagamento
  statusPagamento     StatusPagamento @default(pendente) @map("status_pagamento")
  dataPagamento       DateTime?       @map("data_pagamento") @db.Date
  formaPagamento      String?         @map("forma_pagamento")
  referenciaPagamento String?         @map("referencia_pagamento")

  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  // Relations
  os         OS          @relation(fields: [osId], references: [id], onDelete: Cascade)
  fornecedor Fornecedor? @relation(fields: [fornecedorId], references: [id])

  @@index([osId])
  @@index([data])
  @@index([nome])
  @@index([statusPagamento])
  @@index([statusPagamento, data]) // Índice composto para alertas de despesas vencidas
  @@map("os_atividades")
}

model Hospedagem {
  id            String             @id @default(uuid())
  osId          String             @map("os_id")
  fornecedorId  String             @map("fornecedor_id")
  tarifaId      String?            @map("tarifa_id")
  hotelNome     String             @map("hotel_nome")
  checkin       DateTime
  checkout      DateTime
  quartos       Int?
  tipoQuarto    String?            @map("tipo_quarto")
  regime        RegimeHospedagem?
  custoTotal    Decimal?           @map("custo_total") @db.Decimal(12, 2)
  moeda         Moeda              @default(BRL)
  observacoes   String?            @db.Text
  reservasRefs  Json?              @map("reservas_refs")

  // Controle de Pagamento
  statusPagamento     StatusPagamento @default(pendente) @map("status_pagamento")
  dataPagamento       DateTime?       @map("data_pagamento") @db.Date
  formaPagamento      String?         @map("forma_pagamento")
  referenciaPagamento String?         @map("referencia_pagamento")

  createdAt     DateTime           @default(now()) @map("created_at")
  updatedAt     DateTime           @updatedAt @map("updated_at")

  // Relations
  os         OS                 @relation(fields: [osId], references: [id], onDelete: Cascade)
  fornecedor Fornecedor         @relation(fields: [fornecedorId], references: [id])
  tarifa     FornecedorTarifa?  @relation(fields: [tarifaId], references: [id])

  @@index([osId])
  @@index([fornecedorId])
  @@index([tarifaId])
  @@index([checkin])
  @@index([checkout])
  @@index([statusPagamento])
  @@index([statusPagamento, checkout]) // Índice composto para alertas de despesas vencidas
  @@map("os_hospedagens")
}

model Transporte {
  id           String          @id @default(uuid())
  osId         String          @map("os_id")
  tipo         TipoTransporte
  fornecedorId String?         @map("fornecedor_id")
  origem       String?
  destino      String?
  dataPartida  DateTime?       @map("data_partida")
  dataChegada  DateTime?       @map("data_chegada")
  custo        Decimal?        @db.Decimal(12, 2)
  moeda        Moeda           @default(BRL)
  detalhes     Json?

  // Controle de Pagamento
  statusPagamento     StatusPagamento @default(pendente) @map("status_pagamento")
  dataPagamento       DateTime?       @map("data_pagamento") @db.Date
  formaPagamento      String?         @map("forma_pagamento")
  referenciaPagamento String?         @map("referencia_pagamento")

  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")

  // Relations
  os         OS          @relation(fields: [osId], references: [id], onDelete: Cascade)
  fornecedor Fornecedor? @relation(fields: [fornecedorId], references: [id])

  @@index([osId])
  @@index([tipo])
  @@index([dataPartida])
  @@index([dataChegada])
  @@index([statusPagamento])
  @@index([statusPagamento, dataPartida]) // Índice composto para alertas de despesas vencidas
  @@map("os_transportes")
}

model PassagemAerea {
  id           String                  @id @default(uuid())
  osId         String                  @map("os_id")
  categoria    CategoriaPassagemAerea
  passageiroNome String                @map("passageiro_nome")
  cia          String?
  pnr          String?
  trecho       String?
  dataPartida  DateTime?               @map("data_partida")
  dataChegada  DateTime?               @map("data_chegada")
  custo        Decimal?                @db.Decimal(12, 2)
  moeda        Moeda                   @default(BRL)

  // Controle de Pagamento
  statusPagamento     StatusPagamento @default(pendente) @map("status_pagamento")
  dataPagamento       DateTime?       @map("data_pagamento") @db.Date
  formaPagamento      String?         @map("forma_pagamento")
  referenciaPagamento String?         @map("referencia_pagamento")

  createdAt    DateTime                @default(now()) @map("created_at")
  updatedAt    DateTime                @updatedAt @map("updated_at")

  // Relations
  os OS @relation(fields: [osId], references: [id], onDelete: Cascade)

  @@index([osId])
  @@index([categoria])
  @@index([dataPartida])
  @@index([statusPagamento])
  @@map("os_passagens_aereas")
}

model GuiaDesignacao {
  id        String   @id @default(uuid())
  osId      String   @map("os_id")
  guiaId    String   @map("guia_id")
  funcao    String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  os   OS      @relation(fields: [osId], references: [id], onDelete: Cascade)
  guia Usuario @relation(fields: [guiaId], references: [id])

  @@unique([osId, guiaId])
  @@map("os_guias_designacao")
}

model MotoristaDesignacao {
  id           String          @id @default(uuid())
  osId         String          @map("os_id")
  motoristaId  String          @map("motorista_id")
  veiculoTipo  TipoTransporte? @map("veiculo_tipo")
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")

  // Relations
  os        OS      @relation(fields: [osId], references: [id], onDelete: Cascade)
  motorista Usuario @relation(fields: [motoristaId], references: [id])

  @@unique([osId, motoristaId])
  @@map("os_motoristas_designacao")
}

model Scouting {
  id           String   @id @default(uuid())
  osId         String   @map("os_id")
  autorId      String   @map("autor_id")
  titulo       String
  descricao    String?
  roteiroJson  Json?    @map("roteiro_json")
  anexos       Json?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  os    OS      @relation(fields: [osId], references: [id], onDelete: Cascade)
  autor Usuario @relation(fields: [autorId], references: [id])

  @@index([osId])
  @@index([autorId])
  @@index([createdAt])
  @@map("os_scoutings")
}

model LancamentoFinanceiro {
  id                   String               @id @default(uuid())
  orgId                String               @map("org_id")
  osId                 String?              @map("os_id")
  referenciaUsuarioId  String?              @map("referencia_usuario_id")
  fornecedorId         String?              @map("fornecedor_id")
  tipo                 TipoLancamento
  categoria            CategoriaLancamento
  valor                Decimal              @db.Decimal(12, 2)
  moeda                Moeda                @default(BRL)
  data                 DateTime             @db.Date
  observacao           String?
  comprovanteUrl       String?              @map("comprovante_url")
  createdBy            String               @map("created_by")
  createdAt            DateTime             @default(now()) @map("created_at")
  updatedAt            DateTime             @updatedAt @map("updated_at")

  // Relations
  organizacao       Organizacao @relation(fields: [orgId], references: [id], onDelete: Cascade)
  os                OS?         @relation(fields: [osId], references: [id])
  referenciaUsuario Usuario?    @relation("LancamentoReferenciaUsuario", fields: [referenciaUsuarioId], references: [id])
  fornecedor        Fornecedor? @relation(fields: [fornecedorId], references: [id])
  criador           Usuario     @relation("LancamentoCriadoPor", fields: [createdBy], references: [id])

  @@index([orgId])
  @@index([osId])
  @@index([categoria])
  @@index([data])
  @@map("financeiro_lancamentos")
}

// ============================================
// PAGAMENTOS OS (Controle de Parcelas)
// ============================================

model PagamentoOS {
  id              String          @id @default(uuid())
  orgId           String          @map("org_id")
  osId            String          @map("os_id")

  // Tipo: 'entrada' (recebimento do cliente) ou 'saida' (pagamento a fornecedor)
  tipo            String          // 'entrada' | 'saida'
  descricao       String          // Ex: "Entrada 30%", "Saldo 70%", "Pagamento Hotel"

  // Valores
  valor           Decimal         @db.Decimal(12, 2)
  moeda           Moeda           @default(BRL)

  // Datas
  dataVencimento  DateTime        @map("data_vencimento") @db.Date
  dataPagamento   DateTime?       @map("data_pagamento") @db.Date

  // Status
  status          StatusPagamento @default(pendente)

  // Detalhes do pagamento
  formaPagamento  String?         @map("forma_pagamento") // pix, cartao_credito, boleto, dinheiro, transferencia
  referencia      String?         // Número de referência, transação, nota fiscal, etc
  comprovanteUrl  String?         @map("comprovante_url")

  // Relacionamento (opcional) com fornecedor para pagamentos de saída
  fornecedorId    String?         @map("fornecedor_id")

  // Observações
  observacoes     String?         @db.Text

  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  // Relations
  organizacao Organizacao @relation(fields: [orgId], references: [id], onDelete: Cascade)
  os          OS          @relation(fields: [osId], references: [id], onDelete: Cascade)
  fornecedor  Fornecedor? @relation(fields: [fornecedorId], references: [id])

  @@index([orgId])
  @@index([osId])
  @@index([tipo])
  @@index([status])
  @@index([dataVencimento])
  @@index([dataPagamento])
  @@index([fornecedorId])
  @@index([orgId, status, dataVencimento]) // Índice composto para alertas
  @@index([status, dataVencimento]) // Índice para consultas de pagamentos pendentes
  @@map("os_pagamentos")
}

model Anotacao {
  id        String   @id @default(uuid())
  osId      String   @map("os_id")
  autorId   String   @map("autor_id")
  texto     String
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  os    OS      @relation(fields: [osId], references: [id], onDelete: Cascade)
  autor Usuario @relation(fields: [autorId], references: [id])

  @@index([osId])
  @@index([autorId])
  @@index([createdAt])
  @@map("os_anotacoes")
}

model HistoricoStatus {
  id          String    @id @default(uuid())
  osId        String    @map("os_id")
  de          StatusOS?
  para        StatusOS
  alteradoPor String    @map("alterado_por")
  motivo      String?
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  os      OS      @relation(fields: [osId], references: [id], onDelete: Cascade)
  usuario Usuario @relation(fields: [alteradoPor], references: [id])

  @@index([osId])
  @@index([createdAt])
  @@map("os_historico_status")
}

model EventoCalendario {
  id            String                @id @default(uuid())
  orgId         String                @map("org_id")
  osId          String                @map("os_id")
  titulo        String
  tipo          TipoEventoCalendario
  inicio        DateTime
  fim           DateTime?
  recurso       RecursoCalendario?
  recursoRefId  String?               @map("recurso_ref_id")
  createdAt     DateTime              @default(now()) @map("created_at")
  updatedAt     DateTime              @updatedAt @map("updated_at")

  // Relations
  organizacao Organizacao @relation(fields: [orgId], references: [id], onDelete: Cascade)
  os          OS          @relation(fields: [osId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([osId])
  @@index([inicio])
  @@index([tipo])
  @@map("calendario_eventos")
}

// ============================================
// PRESETS (Alergias, Restrições, Preferências)
// ============================================

enum PresetTipo {
  alergia
  restricao
  preferencia
}

model PresetCategory {
  id        String     @id @default(uuid())
  orgId     String     @map("org_id")
  nome      String
  tipo      PresetTipo
  parentId  String?    @map("parent_id")
  ordem     Int?       
  ativo     Boolean    @default(true)
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  // Relations
  organizacao Organizacao   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  parent      PresetCategory? @relation("PresetCategoryToParent", fields: [parentId], references: [id])
  children    PresetCategory[] @relation("PresetCategoryToParent")
  items       PresetItem[]

  @@index([orgId])
  @@index([tipo])
  @@index([parentId])
  @@index([nome])
  @@map("preset_categories")
}

model PresetItem {
  id          String      @id @default(uuid())
  orgId       String      @map("org_id")
  categoriaId String?     @map("categoria_id")
  tipo        PresetTipo
  label       String
  descricao   String?
  ordem       Int?
  ativo       Boolean     @default(true)
  usoCount    Int         @default(0) @map("uso_count")
  ultimoUso   DateTime?   @map("ultimo_uso")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Relations
  organizacao Organizacao  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  categoria   PresetCategory? @relation(fields: [categoriaId], references: [id])
  templateItems PresetTemplateItem[]

  @@index([orgId])
  @@index([categoriaId])
  @@index([tipo])
  @@index([label])
  @@index([usoCount])
  @@index([ultimoUso])
  @@map("preset_items")
}

// ============================================
// TEMPLATES (Combinações comuns)
// ============================================

model PresetTemplate {
  id          String      @id @default(uuid())
  orgId       String      @map("org_id")
  nome        String
  descricao   String?
  tipo        PresetTipo
  ativo       Boolean     @default(true)
  usoCount    Int         @default(0) @map("uso_count")
  ultimoUso   DateTime?   @map("ultimo_uso")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Relations
  organizacao Organizacao @relation(fields: [orgId], references: [id], onDelete: Cascade)
  items       PresetTemplateItem[]

  @@index([orgId])
  @@index([tipo])
  @@index([nome])
  @@index([usoCount])
  @@map("preset_templates")
}

model PresetTemplateItem {
  id         String         @id @default(uuid())
  templateId String         @map("template_id")
  itemId     String         @map("item_id")
  ordem      Int?
  createdAt  DateTime       @default(now()) @map("created_at")

  // Relations
  template PresetTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  item     PresetItem     @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([templateId, itemId])
  @@index([templateId])
  @@index([itemId])
  @@map("preset_template_items")
}

// ============================================
// AUDITORIA (Sistema de Logs)
// ============================================

model AuditoriaOS {
  id           String            @id @default(uuid())
  orgId        String            @map("org_id")
  osId         String            @map("os_id")

  // Quem fez a ação
  usuarioId    String            @map("usuario_id")
  usuarioNome  String            @map("usuario_nome") // Snapshot do nome no momento da ação
  usuarioRole  RoleGlobal        @map("usuario_role") // Snapshot do role no momento da ação

  // O que foi feito
  acao         AcaoAuditoria
  entidade     EntidadeAuditoria
  entidadeId   String?           @map("entidade_id") // ID do registro afetado (participante, atividade, etc)

  // Detalhes da alteração
  dadosAntigos Json?             @map("dados_antigos") // Estado antes da alteração
  dadosNovos   Json?             @map("dados_novos")   // Estado depois da alteração
  campos       String[]          // Lista de campos que foram alterados

  // Contexto adicional
  descricao    String?           // Descrição legível da ação
  metadata     Json?             // Informações extras (IP, user-agent, duração, etc)

  // Quando aconteceu
  createdAt    DateTime          @default(now()) @map("created_at")

  // Relations
  organizacao  Organizacao       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  os           OS                @relation(fields: [osId], references: [id], onDelete: Cascade)
  usuario      Usuario           @relation(fields: [usuarioId], references: [id])

  @@index([orgId])
  @@index([osId])
  @@index([usuarioId])
  @@index([acao])
  @@index([entidade])
  @@index([entidadeId])
  @@index([createdAt])
  @@index([osId, createdAt]) // Índice composto para queries de timeline
  @@index([osId, entidade])  // Índice composto para filtrar por entidade em uma OS
  @@map("auditoria_os")
}

// ============================================
// POLÍTICAS (Regras configuráveis por organização)
// ============================================

model OrganizacaoPolicy {
  id          String     @id @default(uuid())
  orgId       String     @map("org_id")
  nome        String
  descricao   String?
  versao      Int        @default(1)
  ativa       Boolean    @default(false)

  // Blocos de configuração (JSON para flexibilidade e evolução)
  financeiro  Json       // { margemMinimaPercentual: number, entradaMinimaPercentual: number, toleranciaCustoRealAcimaEstimadoPercentual: number }
  prazos      Json       // { prazoMinimoGuiaDias: number, prazoMinimoMotoristaDias: number, prazoMinimoHospedagemDias: number }
  checklistsOverrides Json? @map("checklists_overrides") // Overrides por transição de status

  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  // Relations
  organizacao Organizacao @relation(fields: [orgId], references: [id], onDelete: Cascade)
  osSnapshots OSPolicySnapshot[]

  @@index([orgId])
  @@index([orgId, ativa])
  @@index([orgId, versao])
  @@map("organizacao_policies")
}

model OSPolicySnapshot {
  id        String   @id @default(uuid())
  osId      String   @map("os_id")
  policyId  String   @map("policy_id")
  versao    Int
  snapshot  Json
  appliedAt DateTime @default(now()) @map("applied_at")

  // Relations
  os     OS                @relation(fields: [osId], references: [id], onDelete: Cascade)
  policy OrganizacaoPolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@index([osId])
  @@index([policyId])
  @@map("os_policy_snapshots")
}

// ============================================
// COTAÇÕES (Sistema de Cotações Rápidas)
// ============================================

enum StatusCotacao {
  rascunho
  enviada
  aceita
  perdida
  expirada
}

model Cotacao {
  id                   String         @id @default(uuid())
  orgId                String         @map("org_id")
  titulo               String
  clienteNome          String         @map("cliente_nome")
  clienteEmail         String?        @map("cliente_email")
  clienteTelefone      String?        @map("cliente_telefone")
  destino              String
  dataInicio           DateTime?      @map("data_inicio") @db.Date
  dataFim              DateTime?      @map("data_fim") @db.Date
  statusCotacao        StatusCotacao  @default(rascunho) @map("status_cotacao")
  observacoesInternas  String?        @map("observacoes_internas") @db.Text
  observacoesCliente   String?        @map("observacoes_cliente") @db.Text
  responsavelId        String         @map("responsavel_id")
  valorTotal           Decimal?       @map("valor_total") @db.Decimal(12, 2)
  moeda                Moeda          @default(BRL)
  createdAt            DateTime       @default(now()) @map("created_at")
  updatedAt            DateTime       @updatedAt @map("updated_at")

  // Relations
  organizacao   Organizacao      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  responsavel   Usuario          @relation(fields: [responsavelId], references: [id])
  itens         CotacaoItem[]

  @@index([orgId])
  @@index([responsavelId])
  @@index([statusCotacao])
  @@index([dataInicio])
  @@index([createdAt])
  @@map("cotacoes")
}

enum CategoriaCotacaoItem {
  hospedagem
  atividade
  transporte
  alimentacao
}

model CotacaoItem {
  id              String                @id @default(uuid())
  cotacaoId       String                @map("cotacao_id")
  categoria       CategoriaCotacaoItem
  fornecedorId    String?               @map("fornecedor_id")
  tarifaId        String?               @map("tarifa_id")
  descricao       String
  quantidade      Int
  valorUnitario   Decimal               @map("valor_unitario") @db.Decimal(12, 2)
  moeda           Moeda                 @default(BRL)
  subtotal        Decimal               @db.Decimal(12, 2)
  observacoes     String?               @db.Text
  createdAt       DateTime              @default(now()) @map("created_at")
  updatedAt       DateTime              @updatedAt @map("updated_at")

  // Relations
  cotacao     Cotacao      @relation(fields: [cotacaoId], references: [id], onDelete: Cascade)
  fornecedor  Fornecedor?  @relation(fields: [fornecedorId], references: [id])

  @@index([cotacaoId])
  @@index([fornecedorId])
  @@index([categoria])
  @@map("cotacao_itens")
}
